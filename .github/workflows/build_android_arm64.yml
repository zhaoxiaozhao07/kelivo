name: Build Android arm64-v8a

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  FLUTTER_CHANNEL: 'master'

jobs:
  android-arm64:
    name: æ„å»º Android arm64-v8a
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ å®‰è£… Flutter (Master)
        uses: subosito/flutter-action@v2
        with:
          channel: master
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF

      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"

      # å¦‚æœæœ‰ç­¾åå¯†é’¥ï¼Œå†™å…¥å¯†é’¥æ–‡ä»¶
      - name: ğŸ”‘ å†™å…¥ç­¾åå¯†é’¥
        if: ${{ env.SIGN_KEYSTORE_BASE64 != '' }}
        env:
          SIGN_KEYSTORE_BASE64: ${{ secrets.SIGN_KEYSTORE_BASE64 }}
        run: |
          echo "$SIGN_KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          echo "storeFile=key.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "âœ… ç­¾åé…ç½®å·²å†™å…¥"

      - name: ğŸ—ï¸ æ„å»º APK (ä»… arm64-v8a)
        run: flutter build apk --release --target-platform android-arm64

      - name: ğŸ“¦ é‡å‘½å APK
        run: |
          cd build/app/outputs/flutter-apk
          mv app-release.apk "Kelivo_android_${VERSION}_arm64-v8a.apk"

      - name: ï¿½ å‘å¸ƒåˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          files: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk
          token: ${{ secrets.TOKEN }}

      - name: ï¿½ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk
